<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Or√ßaf√°cil METLAL</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body {
      font-family: 'Inter', sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f4f6f8;
      color: #333;
    }
    .container {
      max-width: 850px;
      margin: 30px auto;
      background: #fff;
      border-radius: 12px;
      padding: 30px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }
    .empresa-info {
      text-align: center;
      margin-bottom: 20px;
    }
    .empresa-info img {
      max-width: 200px;
      margin-bottom: 10px;
    }
    h1, h2, h3 {
      color: #0056b3;
    }
    label {
      font-weight: 600;
      display: block;
      margin: 10px 0 4px;
    }
    input, select {
      width: 100%;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 8px;
      margin-bottom: 14px;
      font-size: 14px;
    }
    button {
      background-color: #0056b3;
      color: white;
      padding: 12px 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
      transition: background 0.3s;
    }
    button:hover {
      background-color: #003f88;
    }
    #itensOrcamento {
      margin-top: 30px;
      background: #f1f3f5;
      border-radius: 10px;
      padding: 20px;
    }
    ul {
      padding-left: 20px;
    }
    ul li {
      margin-bottom: 12px;
      line-height: 1.5;
    }
    .total {
      font-size: 18px;
      font-weight: bold;
      color: green;
    }
    .assinaturas {
      margin-top: 40px;
    }
    .assinaturas div {
      display: inline-block;
      width: 45%;
      text-align: center;
      margin-top: 40px;
    }
    .assinaturas div hr {
      border: 0;
      border-top: 1px solid #ccc;
      margin-bottom: 6px;
    }
    @media (max-width: 600px) {
      .assinaturas div {
        display: block;
        width: 100%;
        margin-bottom: 40px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="empresa-info">
      <img src="logo-metlal.png" alt="Logo METLAL">
      <h2>METLAL METAL√öRGICA LADEIRA LTDA</h2>
      <p>CNPJ: 00.000.000/0001-00</p>
      <p>Rua Juruc√™, 78 ‚Äì Col√©gio ‚Äì Rio de Janeiro ‚Äì RJ</p>
      <p>CEP: 21545-170</p>
    </div>

    <form id="orcamentoForm">
      <label for="cliente">Nome do Cliente:</label>
      <input type="text" id="cliente" required>

      <label for="numero">N√∫mero do Or√ßamento:</label>
      <input type="text" id="numero" readonly>

      <label for="data">Data:</label>
      <input type="date" id="data" readonly>

      <label for="produto">Produto:</label>
      <select id="produto">
        <option value="">Carregando...</option>
      </select>

      <label for="largura">Largura (m):</label>
      <input type="number" id="largura" step="0.01">

      <label for="altura">Altura (m):</label>
      <input type="number" id="altura" step="0.01">

      <label for="comprimento">Comprimento (m):</label>
      <input type="number" id="comprimento" step="0.01">

      <label for="quantidade">Quantidade:</label>
      <input type="number" id="quantidade" min="1" value="1" required>

      <button type="button" onclick="adicionarItem()">‚ûï Adicionar ao Or√ßamento</button>
    </form>

    <div id="itensOrcamento"></div>

    <div style="text-align: center; margin-top: 20px;">
      <button onclick="gerarPDF()">üì• Baixar Or√ßamento em PDF</button>
    </div>
  </div>

  <script>
    const tabelaPreco = {};
    let itens = [];

    const sheetID = "1HhXN32p7V9NtzuuG-Xr03uBts_W2yNLBqosnZuWwGn8";
    const sheetName = "P√°gina1";
    const url = https://docs.google.com/spreadsheets/d/${sheetID}/gviz/tq?sheet=${sheetName};

    window.onload = () => {
      carregarPrecos();
      document.getElementById("data").value = new Date().toISOString().split('T')[0];
      document.getElementById("numero").value = "ORC-" + Date.now().toString().slice(-6);
    };

    function carregarPrecos() {
      fetch(url)
        .then(res => res.text())
        .then(data => {
          const start = data.indexOf('{');
          const end = data.lastIndexOf('}') + 1;
          const json = JSON.parse(data.slice(start, end));
          const rows = json.table.rows;
          const select = document.getElementById("produto");
          select.innerHTML = "<option value=''>Selecione</option>";
          rows.forEach(row => {
            const nome = row.c[0]?.v;
            const preco = parseFloat(row.c[1]?.v);
            const tipo = row.c[2]?.v?.toLowerCase();
            if (nome && preco && tipo) {
              const key = nome.toLowerCase();
              tabelaPreco[key] = { preco, tipo };
              const opt = document.createElement("option");
              opt.value = key;
              opt.textContent = nome;
              select.appendChild(opt);
            }
          });
        })
        .catch(err => {
          console.error("Erro:", err);
          alert("Erro ao carregar os dados da planilha.");
        });
    }

    function adicionarItem() {
      const produto = document.getElementById("produto").value;
      const largura = parseFloat(document.getElementById("largura").value);
      const altura = parseFloat(document.getElementById("altura").value);
      const comprimento = parseFloat(document.getElementById("comprimento").value);
      const quantidade = parseInt(document.getElementById("quantidade").value);

      if (!produto || isNaN(quantidade)) {
        alert("Preencha todos os campos obrigat√≥rios.");
        return;
      }

      const { preco, tipo } = tabelaPreco[produto];
      let total = 0;
      let medida = "";

      if (tipo === "m2") {
        if (isNaN(largura) || isNaN(altura)) return alert("Informe largura e altura.");
        total = preco * (largura * altura * quantidade);
        medida = (${largura}m x ${altura}m);
      } else if (tipo === "metro") {
        if (isNaN(comprimento)) return alert("Informe o comprimento.");
        total = preco * comprimento * quantidade;
        medida = (${comprimento}m linear);
      } else if (tipo === "unidade") {
        total = preco * quantidade;
      }

      itens.push({ nome: produto, quantidade, total, preco, medida, tipo });
      atualizarOrcamento();
    }

    function atualizarOrcamento() {
      const div = document.getElementById("itensOrcamento");
      let html = "<h3>Itens do Or√ßamento</h3><ul>";
      let totalGeral = 0;
      itens.forEach((item, i) => {
        html += `<li><strong>${item.nome}</strong> ${item.medida || ""} - ${item.quantidade} x R$ ${item.preco.toFixed(2)} = R$ ${item.total.toFixed(2)} 
          <button onclick="removerItem(${i})">‚ùå Remover</button></li>`;
        totalGeral += item.total;
      });
      html += "</ul><p class='total'>Total: R$ " + totalGeral.toFixed(2) + "</p>";
      html += `
        <div class="assinaturas">
          <div><hr><p>Assinatura do Cliente</p></div>
          <div><hr><p>Assinatura do Vendedor</p></div>
        </div>`;
      div.innerHTML = html;
    }

    function removerItem(index) {
      itens.splice(index, 1);
      atualizarOrcamento();
    }

    function gerarPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      const cliente = document.getElementById("cliente").value;
      const numero = document.getElementById("numero").value;
      const data = document.getElementById("data").value;

      if (!cliente || itens.length === 0) {
        alert("Informe o nome do cliente e adicione ao menos um produto.");
        return;
      }

      let y = 10;
      doc.setFontSize(12);
      doc.text("METLAL METAL√öRGICA LADEIRA LTDA", 10, y); y+=6;
      doc.text("CNPJ: 00.000.000/0001-00", 10, y); y+=6;
      doc.text("Rua Juruc√™, 78 ‚Äì Col√©gio ‚Äì Rio de Janeiro ‚Äì RJ", 10, y); y+=6;
      doc.text("CEP: 21545-170", 10, y); y+=10;

      doc.setFontSize(14);
      doc.text("OR√áAMENTO", 105, y, null, null, "center"); y+=10;

      doc.setFontSize(12);
      doc.text(Cliente: ${cliente}, 10, y); y+=6;
      doc.text(N√∫mero: ${numero}, 10, y); y+=6;
      doc.text(Data: ${data}, 10, y); y+=10;

      itens.forEach(item => {
        doc.text(- ${item.nome} ${item.medida || ""} | Qtde: ${item.quantidade} | Total: R$ ${item.total.toFixed(2)}, 10, y);
        y += 7;
      });

      const total = itens.reduce((acc, cur) => acc + cur.total, 0);
      doc.setFontSize(13);
      y += 5;
      doc.text(TOTAL GERAL: R$ ${total.toFixed(2)}, 10, y); y+=20;

      doc.line(20, y, 90, y); y+=5;
      doc.text("Assinatura do Cliente", 30, y); y+=15;
      doc.line(120, y-15, 190, y-15);
      doc.text("Assinatura do Vendedor", 135, y);

      doc.save(orcamento_${numero}.pdf);
    }
  </script>
</body>
</html>
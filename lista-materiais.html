<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Libera√ß√£o de Materiais</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #e8f0fe;
      margin: 0;
      padding: 0;
    }
    .container {
      max-width: 800px;
      margin: 50px auto;
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 0 10px #aaa;
    }
    h2 {
      text-align: center;
      color: #003366;
    }
    input, button {
      width: 100%;
      padding: 10px;
      margin: 10px 0;
      border-radius: 5px;
      border: 1px solid #ccc;
    }
    button {
      background: #004a99;
      color: #fff;
      cursor: pointer;
    }
    button:hover {
      background: #003366;
    }
    .lista {
      margin-top: 20px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    table th, table td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: left;
    }
    #msg {
      color: red;
    }
  </style>
</head>
<body>
<div class="container">
  <h2>üì¶ Libera√ß√£o de Materiais</h2>

  <label>N√∫mero do Or√ßamento:</label>
  <input id="numeroOrcamento" type="text" placeholder="Ex: MT0001">

  <button onclick="buscarOrcamento()">üîç Buscar e Gerar Lista</button>

  <p id="msg"></p>

  <div class="lista" id="listaMateriais"></div>

  <button onclick="gerarPDF()">üì• Gerar PDF</button>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
const webAppURL = "https://script.google.com/macros/s/AKfycbxQf_AyVZrus_Xs-ckOWeFJMdBEs-BFlPWyj1-Mn9fXG78MG7tCUoyeqLLYZD_5IeNA/exec";
let dadosOrcamento = null;
let estruturaFinal = [];

function buscarOrcamento() {
  const numero = document.getElementById("numeroOrcamento").value.trim();
  document.getElementById("msg").textContent = "";
  document.getElementById("listaMateriais").innerHTML = "";

  if (!numero) return alert("Digite um n√∫mero de or√ßamento.");

  fetch(`${webAppURL}?tipo=buscar&numero=${numero}`)
    .then(res => res.json())
    .then(dados => {
      if (dados.erro) throw new Error(dados.erro);
      dadosOrcamento = dados;
      return fetch(`${webAppURL}?tipo=estrutura&produto=${encodeURIComponent(dados.produto)}`);
    })
    .then(res => res.json())
    .then(estrutura => {
      estruturaFinal = estrutura.map(item => {
        const quantidadeTotal = item.multiplicador * parseFloat(dadosOrcamento.quantidade);
        return {
          ...item,
          total: quantidadeTotal
        };
      });

      mostrarMateriais();
    })
    .catch(err => {
      document.getElementById("msg").textContent = "Erro ao buscar dados. Verifique se as abas e o compartilhamento da planilha est√£o corretos.";
      console.error(err);
    });
}

function mostrarMateriais() {
  let html = `<h3>Materiais para: ${dadosOrcamento.produto} (${dadosOrcamento.quantidade} un)</h3>`;
  html += "<table><tr><th>Item</th><th>Medida</th><th>Unidade</th><th>Total</th></tr>";
  estruturaFinal.forEach(item => {
    html += `<tr>
      <td>${item.item}</td>
      <td>${item.medida}</td>
      <td>${item.unidade}</td>
      <td>${item.total}</td>
    </tr>`;
  });
  html += "</table>";
  document.getElementById("listaMateriais").innerHTML = html;
}

function gerarPDF() {
  if (!dadosOrcamento || estruturaFinal.length === 0) {
    return alert("Nenhum material carregado.");
  }

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();

  doc.setFontSize(14);
  doc.text("Libera√ß√£o de Materiais", 105, 15, { align: "center" });
  doc.setFontSize(10);
  doc.text(`Or√ßamento: ${dadosOrcamento.numero}`, 10, 25);
  doc.text(`Produto: ${dadosOrcamento.produto}`, 10, 30);
  doc.text(`Quantidade: ${dadosOrcamento.quantidade}`, 10, 35);
  doc.text(`Cliente: ${dadosOrcamento.cliente}`, 10, 40);

  const body = estruturaFinal.map(item => [item.item, item.medida, item.unidade, item.total]);
  doc.autoTable({
    startY: 45,
    head: [["Item", "Medida", "Unidade", "Total"]],
    body: body
  });

  doc.save(`${dadosOrcamento.numero}_liberacao.pdf`);

  const textoFinal = estruturaFinal.map(i => `${i.item} (${i.total} ${i.unidade})`).join(" | ");
  fetch(webAppURL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      tipo: "salvar",
      numero: dadosOrcamento.numero,
      produto: dadosOrcamento.produto,
      quantidade: dadosOrcamento.quantidade,
      itens: textoFinal,
      usuario: dadosOrcamento.usuario || "admin"
    })
  }).then(res => res.text()).then(msg => {
    alert(msg);
  }).catch(err => alert("Erro ao salvar: " + err.message));
}
</script>
</body>
</html>

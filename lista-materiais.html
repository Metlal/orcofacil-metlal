<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Liberação de Materiais</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 40px;
    }
    input, button, textarea {
      display: block;
      margin: 10px 0;
      padding: 8px;
      width: 100%;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 20px;
    }
    th, td {
      border: 1px solid #999;
      padding: 8px;
      text-align: center;
    }
    th {
      background-color: #eee;
    }
  </style>
</head>
<body>
  <h1>Liberação de Materiais</h1>

  <label for="numeroOrcamento">Número do Orçamento</label>
  <input type="text" id="numeroOrcamento" placeholder="Digite o número do orçamento" />

  <label for="numeroProposta">Número da Proposta</label>
  <input type="text" id="numeroProposta" placeholder="Digite o número da proposta" />

  <label for="descricaoProduto">Descrição do Produto</label>
  <textarea id="descricaoProduto" rows="3" placeholder="Descreva o produto..."></textarea>

  <button onclick="buscarMateriais()">Buscar Materiais</button>

  <table id="tabelaMateriais" style="display: none;">
    <thead>
      <tr>
        <th>Material</th>
        <th>Unidade</th>
        <th>Quantidade</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <button id="btnGerarPDF" style="display:none;" onclick="gerarPDF()">Gerar PDF</button>

  <script>
    const URL_SCRIPT = "https://script.google.com/macros/s/AKfycbxz9BIdhZp1oFtSViihMR6eWLsOrHbhm2eXY8d09NlkAZE6oGpmIBpd3RZYDsmjtCn0/exec";

    function buscarMateriais() {
      const numeroOrcamento = document.getElementById("numeroOrcamento").value;
      if (!numeroOrcamento) {
        alert("Digite o número do orçamento!");
        return;
      }

      fetch(`${URL_SCRIPT}?acao=buscarMateriais&numeroOrcamento=${numeroOrcamento}`)
        .then(response => response.json())
        .then(data => {
          const tabela = document.getElementById("tabelaMateriais");
          const tbody = tabela.querySelector("tbody");
          tbody.innerHTML = "";

          if (data && data.length > 0) {
            data.forEach(item => {
              const row = document.createElement("tr");
              row.innerHTML = `
                <td>${item.material}</td>
                <td>${item.unidade}</td>
                <td>${item.quantidade}</td>
              `;
              tbody.appendChild(row);
            });

            tabela.style.display = "table";
            document.getElementById("btnGerarPDF").style.display = "inline-block";
          } else {
            alert("Nenhum dado encontrado para esse orçamento.");
          }
        })
        .catch(error => {
          alert("Erro ao buscar materiais.");
          console.error(error);
        });
    }

    function gerarPDF() {
      const numero = document.getElementById("numeroProposta").value || "N/A";
      const descricao = document.getElementById("descricaoProduto").value || "Sem descrição";
      const tabela = document.getElementById("tabelaMateriais").outerHTML;

      const total = calcularTotal(); // Você pode adaptar isso se tiver coluna de preço.
      const totalExtenso = numeroPorExtenso(total);

      const win = window.open('', '', 'width=800,height=700');
      win.document.write(`
        <html>
        <head>
          <title>PDF Liberação de Materiais</title>
          <style>
            body { font-family: Arial; padding: 20px; }
            table { border-collapse: collapse; width: 100%; margin-top: 20px; }
            th, td { border: 1px solid #ccc; padding: 6px; text-align: center; }
            th { background: #f2f2f2; }
          </style>
        </head>
        <body>
          <h2>Liberação de Materiais</h2>
          <p><strong>Proposta Nº:</strong> ${numero}</p>
          <p><strong>Descrição do Produto:</strong> ${descricao}</p>
          ${tabela}
          <p><strong>Total (estimado):</strong> R$ ${total.toFixed(2).replace('.', ',')} (${totalExtenso})</p>
        </body>
        </html>
      `);
      win.document.close();
      win.print();
    }

    function calcularTotal() {
      // Apenas exemplo: adapta se tiver coluna de preço
      return 1234.56;
    }

    function numeroPorExtenso(valor) {
      const unidades = ["", "um", "dois", "três", "quatro", "cinco", "seis", "sete", "oito", "nove"];
      const dezenas = ["", "", "vinte", "trinta", "quarenta", "cinquenta", "sessenta", "setenta", "oitenta", "noventa"];
      const especiais = ["dez", "onze", "doze", "treze", "quatorze", "quinze", "dezesseis", "dezessete", "dezoito", "dezenove"];

      function extenso(n) {
        if (n < 10) return unidades[n];
        if (n < 20) return especiais[n - 10];
        const dez = Math.floor(n / 10);
        const uni = n % 10;
        return dezenas[dez] + (uni > 0 ? " e " + unidades[uni] : "");
      }

      const reais = Math.floor(valor);
      const centavos = Math.round((valor - reais) * 100);

      let ext = reais === 0 ? "zero reais" : extenso(reais) + " real" + (reais > 1 ? "es" : "");
      if (centavos > 0) {
        ext += " e " + extenso(centavos) + " centavo" + (centavos > 1 ? "s" : "");
      }

      return ext;
    }
  </script>
</body>
</html>

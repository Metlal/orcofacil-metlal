<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Liberação de Materiais (BOM)</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.3/dist/jspdf.plugin.autotable.min.js"></script>
<style>
  :root{
    --bg:#f6f7fb; --card:#fff; --text:#1f2937; --muted:#6b7280; --brand:#0b62d6;
    --brand-700:#0a52b3; --ok:#0ea5e9; --err:#ef4444; --ok2:#16a34a; --bd:#e5e7eb;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);font-family:'Inter',system-ui,Segoe UI,Roboto,Arial,sans-serif;color:var(--text)}
  .wrap{max-width:1100px;margin:24px auto;padding:0 16px}
  .card{background:var(--card);border:1px solid var(--bd);border-radius:12px;box-shadow:0 2px 10px rgba(0,0,0,.03)}
  .head{display:flex;gap:12px;align-items:center;padding:18px 20px;border-bottom:1px solid var(--bd)}
  .logo{width:28px;height:28px;background:linear-gradient(135deg,#93c5fd,#3b82f6);border-radius:8px}
  h1{font-size:20px;margin:0}
  .content{padding:18px 20px}
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
  .input{height:40px;padding:0 12px;border:1px solid var(--bd);border-radius:8px;font:inherit}
  .btn{height:40px;padding:0 14px;border-radius:8px;border:1px solid transparent;cursor:pointer;font-weight:600}
  .btn.primary{background:var(--brand);color:#fff}
  .btn.primary:hover{background:var(--brand-700)}
  .btn.ghost{background:#fff;border-color:var(--bd);color:var(--text)}
  .btn.ghost:hover{border-color:#cbd5e1}
  .status{margin-top:10px;font-size:14px}
  .status.ok{color:var(--ok2)}
  .status.err{color:var(--err)}
  .status.muted{color:var(--muted)}
  .summary{margin-top:12px;border:1px solid var(--bd);border-radius:10px;padding:12px}
  .summary small{color:var(--muted)}
  .chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}
  .chip{background:#eef2ff;border:1px solid #dbeafe;color:#1e40af;padding:4px 8px;border-radius:999px;font-size:12px}
  table{width:100%;border-collapse:collapse;margin-top:14px;border:1px solid var(--bd);border-radius:10px;overflow:hidden}
  th,td{padding:10px 12px;border-bottom:1px solid var(--bd);text-align:left}
  thead th{background:#f3f4f6;font-weight:600}
  tfoot td{background:#f9fafb;font-weight:600}
  @media (max-width:640px){ .row{flex-direction:column;align-items:stretch} .input,.btn{width:100%} }
</style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="head">
        <div class="logo"></div>
        <h1>Liberação de Materiais (BOM)</h1>
      </div>
      <div class="content">
        <div class="row">
          <input id="orcamentoInput" class="input" placeholder="Nº do Orçamento (ex.: MT0001)">
          <button class="btn primary" id="btnGerar">Gerar Lista de Materiais</button>
          <button class="btn ghost" id="btnPdf" disabled>Gerar PDF</button>
        </div>

        <div id="status" class="status muted">Buscando na aba <b>Orçamentos</b> e detalhando com a aba <b>EstruturaProduto</b>.</div>

        <!-- Resumo do orçamento -->
        <div id="resumo" class="summary" style="display:none">
          <div id="resumoHeader" style="display:flex;gap:12px;align-items:center;flex-wrap:wrap;">
            <span class="chip" id="chipOrc"></span>
            <span class="chip" id="chipCliente"></span>
            <span class="chip" id="chipData"></span>
          </div>
          <div style="margin-top:8px">
            <small>Produtos vendidos:</small>
            <div id="chipsProdutos" class="chips"></div>
          </div>
        </div>

        <!-- Tabela BOM -->
        <div id="tabelaWrap" style="display:none">
          <table id="tabela">
            <thead>
              <tr>
                <th>Insumo</th>
                <th>Unidade</th>
                <th style="text-align:right;">Quantidade Total</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
            <tfoot>
              <tr>
                <td colspan="3" id="totalItens">Total de itens: 0</td>
              </tr>
            </tfoot>
          </table>
        </div>

      </div>
    </div>
  </div>

<script>
/** ======= CONFIG ======= **/
const SHEET_ID = "1AVl3zXYmlR0Jr7LpZlMVf28EnpZYMQj1hRU5VUbfcA4";
const ABA_ORCAMENTOS   = "Orçamentos";
const ABA_ESTRUTURA    = "EstruturaProduto";

/** ======= UTILS ======= **/
const norm = s => String(s||"").toLowerCase()
  .normalize("NFD").replace(/\p{Diacritic}/gu,"").trim();

function headerIndex(headers, ...labels){
  const H = headers.map(norm);
  for (const l of labels){
    const i = H.indexOf(norm(l));
    if (i>-1) return i;
  }
  return -1;
}
function statusMsg(msg, cls="muted"){
  const el = document.getElementById("status");
  el.className = "status " + cls;
  el.innerHTML = msg;
}
async function fetchSheet(aba){
  const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=${encodeURIComponent(aba)}`;
  const text = await fetch(url).then(r=>r.text());
  const json = JSON.parse(text.substring(47).slice(0,-2));
  const headers = json.table.cols.map(c=>c.label || "");
  const data = json.table.rows.map(r => (r.c||[]).map(c => c && c.v !== null ? c.v : ""));
  return { headers, data };
}
function fmt(n){ 
  const x = Number(n);
  return Number.isFinite(x) ? (Math.round(x*100)/100).toString().replace(".",",") : n;
}

/** ======= CORE ======= **/
let ultimoBOM = null; // guarda o BOM atual para o PDF

async function gerarLista(){
  const numero = document.getElementById("orcamentoInput").value.trim();
  if (!numero){ statusMsg("Digite o número do orçamento.", "err"); return; }

  document.getElementById("btnPdf").disabled = true;
  document.getElementById("tabelaWrap").style.display = "none";
  document.getElementById("resumo").style.display = "none";
  statusMsg("Carregando dados…", "muted");

  try{
    const [orc, est] = await Promise.all([
      fetchSheet(ABA_ORCAMENTOS),
      fetchSheet(ABA_ESTRUTURA)
    ]);

    // Índices na aba Orçamentos
    const idxNum  = headerIndex(orc.headers, "N° Orçamento","Nº Orçamento");
    const idxProd = headerIndex(orc.headers, "Produtos");
    const idxQtd  = headerIndex(orc.headers, "Quantidade");
    const idxCli  = headerIndex(orc.headers, "Cliente");
    const idxData = headerIndex(orc.headers, "Data");

    if (idxNum<0 || idxProd<0 || idxQtd<0){
      statusMsg('Colunas obrigatórias não encontradas na aba <b>Orçamentos</b>.', "err");
      return;
    }

    // Filtra linhas do orçamento
    const linhas = orc.data.filter(
      r => String(r[idxNum]||"").trim().toUpperCase() === numero.toUpperCase()
    );
    if (linhas.length === 0){
      statusMsg(`Orçamento <b>${numero}</b> não encontrado.`, "err");
      return;
    }

    const cliente = idxCli>=0 ? (linhas[0][idxCli]||"") : "";
    const data    = idxData>=0 ? (linhas[0][idxData]||"") : "";

    // Lista de produtos vendidos (usa SOMENTE a coluna Quantidade)
    const vendidos = linhas.map(r => ({
      nome: String(r[idxProd]||"").trim(),
      qtd:  parseFloat(r[idxQtd]||1) || 1
    })).filter(v => v.nome);

    // Índices na aba EstruturaProduto
    const pIdx = headerIndex(est.headers, "Produto");
    const iIdx = headerIndex(est.headers, "Insumo");
    const qIdx = headerIndex(est.headers, "Quantidade");
    const uIdx = headerIndex(est.headers, "Medidas");
    if (pIdx<0 || iIdx<0 || qIdx<0){
      statusMsg('Colunas obrigatórias não encontradas na aba <b>EstruturaProduto</b>.', "err");
      return;
    }

    // Dicionário de estrutura por produto (normalizado)
    const estrutura = new Map();
    est.data.forEach(r => {
      const produto = String(r[pIdx]||"").trim().toLowerCase();
      if (!produto) return;
      if (!estrutura.has(produto)) estrutura.set(produto, []);
      estrutura.get(produto).push({
        insumo: r[iIdx],
        unidade: r[uIdx] || "",
        qtd: parseFloat(r[qIdx]||0) || 0
      });
    });

    // Monta o BOM consolidado
    const bom = new Map(); // chave = "insumo__unidade" => qtd total
    vendidos.forEach(v => {
      const estProd = estrutura.get(v.nome.toLowerCase());
      if (!estProd) return;
      estProd.forEach(item => {
        const key = `${item.insumo}__${item.unidade}`;
        const soma = (bom.get(key)||0) + (item.qtd * v.qtd);
        bom.set(key, soma);
      });
    });

    // Render resumo
    document.getElementById("resumo").style.display = "block";
    document.getElementById("chipOrc").textContent     = `Orçamento: ${numero}`;
    document.getElementById("chipCliente").textContent = `Cliente: ${cliente||"-"}`;
    document.getElementById("chipData").textContent    = `Data: ${data||"-"}`;

    const chips = document.getElementById("chipsProdutos");
    chips.innerHTML = "";
    vendidos.forEach(v=>{
      const el = document.createElement("span");
      el.className = "chip";
      el.textContent = `${v.nome} (x${v.qtd})`;
      chips.appendChild(el);
    });

    // Render tabela
    const tbody = document.getElementById("tbody");
    tbody.innerHTML = "";
    const linhasBOM = [];
    bom.forEach((qtd, key) => {
      const [insumo, unidade] = key.split("__");
      linhasBOM.push({insumo, Unidade, qtd});
    });
    // ordena por insumo
    linhasBOM.sort((a,b)=>a.insumo.localeCompare(b.insumo, 'pt-BR'));

    linhasBOM.forEach(item=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${item.insumo}</td>
        <td>${item.unidade||""}</td>
        <td style="text-align:right;">${fmt(item.qtd)}</td>
      `;
      tbody.appendChild(tr);
    });

    document.getElementById("totalItens").textContent = `Total de itens: ${linhasBOM.length}`;
    document.getElementById("tabelaWrap").style.display = "block";
    document.getElementById("btnPdf").disabled = linhasBOM.length === 0;

    ultimoBOM = { numero, cliente, data, vendidos, linhasBOM };
    statusMsg(`Lista de materiais gerada com sucesso (${linhasBOM.length} itens).`, "ok");

  }catch(err){
    console.error(err);
    statusMsg("Erro ao carregar dados. Verifique o compartilhamento da planilha e os nomes das abas.", "err");
  }
}

function gerarPDF(){
  if (!ultimoBOM) return;
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();

  // Cabeçalho
  doc.setFontSize(14);
  doc.text("Liberação de Materiais (BOM)", 14, 16);
  doc.setFontSize(11);
  doc.text(`Orçamento: ${ultimoBOM.numero}`, 14, 24);
  doc.text(`Cliente: ${ultimoBOM.cliente||"-"}`, 14, 30);
  doc.text(`Data: ${ultimoBOM.data||"-"}`, 14, 36);

  // Produtos
  const prods = ultimoBOM.vendidos.map(v=>`${v.nome} (x${v.qtd})`).join("  |  ");
  doc.setFontSize(10);
  doc.text("Produtos:", 14, 44);
  doc.text(doc.splitTextToSize(prods, 182), 14, 50);

  // Tabela
  const body = ultimoBOM.linhasBOM.map(i => [i.insumo, i.unidade||"", fmt(i.qtd)]);
  doc.autoTable({
    startY: 60,
    head: [["Insumo", "Unidade", "Quantidade Total"]],
    body,
    styles: { fontSize: 9, cellPadding: 2 },
    headStyles: { fillColor: [11,98,214] },
    columnStyles: { 2: { halign: 'right' } }
  });

  doc.save(`BOM_${ultimoBOM.numero}.pdf`);
}

/** ======= EVENTS ======= **/
document.getElementById("btnGerar").addEventListener("click", gerarLista);
document.getElementById("btnPdf").addEventListener("click", gerarPDF);
document.getElementById("orcamentoInput").addEventListener("keydown", e=>{
  if (e.key==="Enter") gerarLista();
});
</script>
</body>
</html>

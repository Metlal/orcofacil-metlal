<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Libera√ß√£o de Materiais (BOM) ‚Äì Or√ßamentos + EstruturaProduto</title>
<style>
  :root{
    --bg:#f5f7fb; --card:#ffffff; --border:#e6eaf0; --muted:#6b7a90; --ink:#0f172a;
    --brand:#0b5ed7; --brand-2:#0848a6; --ok:#2e7d32; --err:#c62828;
  }
  *{box-sizing:border-box}
  body{margin:0; font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", "Liberation Sans", "Apple Color Emoji", "Segoe UI Emoji"; color:var(--ink); background:var(--bg);}
  .wrap{max-width:1100px; margin:32px auto; padding:0 16px;}
  .card{background:var(--card); border:1px solid var(--border); border-radius:12px; box-shadow:0 6px 18px rgba(16,24,40,.04); padding:20px;}
  h1{margin:0 0 12px; font-size:22px; display:flex; align-items:center; gap:8px}
  h1 .emoji{font-size:22px}
  .row{display:flex; gap:12px; flex-wrap:wrap; margin-top:10px}
  .row > *{flex:1 1 220px}
  label{display:block; font-size:13px; color:var(--muted); margin-bottom:6px}
  input[type="text"]{width:100%; padding:10px 12px; border-radius:8px; border:1px solid var(--border); font-size:14px}
  .btn{appearance:none; border:none; border-radius:8px; padding:10px 14px; font-weight:600; color:#fff; background:var(--brand); cursor:pointer}
  .btn:hover{background:var(--brand-2)}
  .btn.secondary{background:#64748b}
  .btn.secondary:hover{background:#475569}
  .status{margin-top:10px; font-size:14px}
  .status.ok{color:var(--ok)} .status.err{color:var(--err)} .status.muted{color:var(--muted)}
  .pill{display:inline-block; padding:2px 8px; background:#e7f1ff; color:#0b5ed7; border-radius:999px; font-size:12px}
  .mono{font-family: ui-monospace, "SF Mono", Menlo, Consolas, monospace}
  .hint{font-size:12px; color:var(--muted); margin-top:4px}
  table{width:100%; border-collapse:collapse; margin-top:14px}
  th,td{border:1px solid var(--border); padding:8px 10px; font-size:14px}
  th{background:#f1f4f9; text-align:left}
  td.right{text-align:right}
  .section-title{margin:16px 0 6px; font-size:15px; color:var(--muted)}
  .actions{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px}
  .summary{margin-top:6px; font-size:13px; color:var(--muted)}
</style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1><span class="emoji">üì¶</span> Libera√ß√£o de Materiais (BOM)</h1>

      <div class="row">
        <div>
          <label for="orcamentoInput">N¬∫ do Or√ßamento</label>
          <input id="orcamentoInput" type="text" placeholder="Ex.: MT0012" class="mono" />
          <div class="hint">Busca na aba <b>Or√ßamentos</b>.</div>
        </div>
        <div style="flex:0 0 auto; align-self:end;">
          <div class="actions">
            <button id="btnGerar" class="btn">Gerar Lista de Materiais</button>
            <button id="btnPDF" class="btn secondary" disabled>Gerar PDF da Libera√ß√£o</button>
          </div>
        </div>
      </div>

      <div id="status" class="status muted">Informe o n√∫mero e clique em ‚ÄúGerar Lista de Materiais‚Äù.</div>

      <div id="resumoOrcamento" class="summary"></div>

      <div id="resultado" style="margin-top:10px;"></div>
    </div>
  </div>

  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
  /** ========================
   *  CONFIG
   *  ======================== */
  const SHEET_ID = "1AVl3zXYmlR0Jr7LpZlMVf28EnpZYMQj1hRU5VUbfcA4"; // troque se necess√°rio
  const ABA_ORCAMENTOS   = "Or√ßamentos";
  const ABA_ESTRUTURA    = "EstruturaProduto";

  /** ========================
   *  UTIL
   *  ======================== */
  async function fetchSheet(aba){
    const url = `https://docs.google.com/spreadsheets/d/${encodeURIComponent(SHEET_ID)}/gviz/tq?sheet=${encodeURIComponent(aba)}`;
    const res = await fetch(url);
    const text = await res.text();
    const json = JSON.parse(text.substring(47).slice(0,-2));
    const headers = (json.table.cols||[]).map(c => (c.label||"").trim());
    const data = (json.table.rows||[]).map(r => (r.c||[]).map(c => c? c.v : null));
    return {headers, data};
  }
  const norm = s => String(s||"").trim().toLowerCase();
  const normKey = s => String(s||"").trim().toLowerCase().normalize("NFD").replace(/\p{Diacritic}/gu,"");
  function headerIndex(headers, ...names){
    const m = new Map(headers.map((h,i)=>[norm(h), i]));
    for (const n of names){ if (m.has(norm(n))) return m.get(norm(n)); }
    return -1;
  }
  function parseQtdFromProdutosCell(txt){
    // Tenta pegar "Nome (2,5)" -> retorna 2.5; se n√£o tiver, 1
    if (!txt) return 1;
    const m = String(txt).match(/\(\s*([\d.,]+)\s*(?:[a-zA-Z%¬∫¬™]+)?\s*\)$/);
    if (!m) return 1;
    const n = parseFloat(m[1].replace(",", "."));
    return isNaN(n) ? 1 : n;
  }
  function fmt(n){
    const v = Number(n||0);
    return (Math.round(v*1000)/1000).toString().replace(".", ",");
  }
  function statusMsg(msg, type="muted"){
    const el = document.getElementById("status");
    el.textContent = msg; el.className = `status ${type}`;
  }

  let ultimoContextoPDF = null;

  document.getElementById("btnGerar").addEventListener("click", gerarLista);
  document.getElementById("btnPDF").addEventListener("click", gerarPDF);

  async function gerarLista(){
    const numero = (document.getElementById("orcamentoInput").value||"").trim();
    if (!numero){ statusMsg("Digite o n√∫mero do or√ßamento.", "err"); return; }

    try{
      statusMsg("Carregando dados‚Ä¶", "muted");
      const [orc, est] = await Promise.all([fetchSheet(ABA_ORCAMENTOS), fetchSheet(ABA_ESTRUTURA)]);

      // ---- Or√ßamentos: localizar TODAS as linhas desse or√ßamento
      const idxNum  = headerIndex(orc.headers, "N¬∞ Or√ßamento","N¬∫ Or√ßamento","Numero do Or√ßamento","N√∫mero do Or√ßamento","Or√ßamento");
      const idxProd = headerIndex(orc.headers, "Produtos","Produto","Item");
      const idxQtd  = headerIndex(orc.headers, "Quantidade","Qtd");
      const idxCli  = headerIndex(orc.headers, "Cliente");
      const idxData = headerIndex(orc.headers, "Data");

      if (idxNum<0 || idxProd<0){
        statusMsg('N√£o encontrei colunas esperadas na aba "Or√ßamentos" (ex.: ‚ÄúN¬∞ Or√ßamento‚Äù, ‚ÄúProdutos‚Äù).', "err");
        return;
      }
      // Todas as linhas do or√ßamento
      const linhas = orc.data.filter(r => String(r[idxNum]||"").trim().toUpperCase() === numero.toUpperCase());
      if (linhas.length === 0){
        statusMsg(`Or√ßamento ${numero} n√£o encontrado na aba "Or√ßamentos".`, "err");
        document.getElementById("resultado").innerHTML = "";
        document.getElementById("resumoOrcamento").innerHTML = "";
        document.getElementById("btnPDF").disabled = true;
        return;
      }

      // Cliente/Data da primeira linha
      const cliente = idxCli>=0 ? (linhas[0][idxCli]||"") : "";
      const data    = idxData>=0 ? (linhas[0][idxData]||"") : "";

      // Produtos vendidos: usa a coluna Quantidade se existir; sen√£o, tenta (x) do texto; fallback 1
      const vendidos = linhas.map(r=>{
        const nome = (r[idxProd]||"").toString().trim();
        let qtd = 1;
        if (idxQtd>=0 && r[idxQtd]!=null){
          const qv = parseFloat(String(r[idxQtd]).replace(",", "."));
          qtd = isNaN(qv)? 1 : qv;
        }else{
          qtd = parseQtdFromProdutosCell(nome);
        }
        return { nome, qtd };
      });

      // ---- EstruturaProduto em mapa
      const pIdx = headerIndex(est.headers, "Produto","Produto Pai","Produto Base");
      const iIdx = headerIndex(est.headers, "Insumo","Material","Pe√ßa","Componente");
      const qIdx = headerIndex(est.headers, "Quantidade","Qtd","Consumo");
      const uIdx = headerIndex(est.headers, "Unidade","Und","Unid");
      if (pIdx<0 || iIdx<0 || qIdx<0){
        statusMsg('N√£o encontrei colunas esperadas na aba "EstruturaProduto" (ex.: ‚ÄúProduto‚Äù, ‚ÄúInsumo‚Äù, ‚ÄúQuantidade‚Äù).', "err");
        return;
      }

      const estruturaPorProduto = new Map();
      for (const r of est.data){
        const prod = r[pIdx]; const insumo = r[iIdx];
        const qtd  = parseFloat(String(r[qIdx]??"0").replace(",", "."));
        const und  = uIdx>=0 ? (r[uIdx]||"") : "";
        if (!prod || !insumo || !qtd) continue;
        const key = normKey(prod);
        if (!estruturaPorProduto.has(key)) estruturaPorProduto.set(key, []);
        estruturaPorProduto.get(key).push({insumo:String(insumo).trim(), qtd, unidade:String(und).trim()});
      }

      // ---- Agregar BOM
      const agreg = new Map();  // "insumo__unidade" -> quantidade
      const faltantes = [];
      vendidos.forEach(v=>{
        const key = normKey(v.nome);
        const lista = estruturaPorProduto.get(key);
        if (!lista){ faltantes.push(v.nome); return; }
        lista.forEach(item=>{
          const k = `${item.insumo}__${item.unidade||""}`;
          const val = (agreg.get(k)||0) + v.qtd*item.qtd;
          agreg.set(k, val);
        });
      });

      // Linhas ordenadas
      const linhasBOM = [];
      agreg.forEach((qtd,k)=>{
        const [insumo, unidade] = k.split("__");
        linhasBOM.push({insumo, unidade:unidade, quantidade:qtd});
      });
      linhasBOM.sort((a,b)=>a.insumo.localeCompare(b.insumo,"pt-BR"));

      // ---- Render
      const resumo = `
        <span class="pill">Or√ßamento</span> <b class="mono">${numero}</b>
        ${cliente?` ¬∑ Cliente: <b>${cliente}</b>`:""}
        ${data?` ¬∑ Data: <b>${data}</b>`:""}
        <div class="hint">Produtos vendidos: ${
          vendidos.map(v=>`${v.nome} (x${fmt(v.qtd).replace(",",".")})`).join(" | ")
        }</div>
      `;
      document.getElementById("resumoOrcamento").innerHTML = resumo;

      const tabela = [
        `<div class="section-title">Materiais consolidados</div>`,
        `<table>
          <thead>
            <tr><th>Insumo</th><th>Unidade</th><th class="right">Quantidade Total</th></tr>
          </thead><tbody>`,
        ...linhasBOM.map(l=>`<tr><td>${l.insumo}</td><td>${l.unidade||""}</td><td class="right">${fmt(l.quantidade)}</td></tr>`),
        `</tbody></table>`
      ].join("");

      const alerta = faltantes.length
        ? `<div class="status err">Aten√ß√£o: produtos sem estrutura: <b>${faltantes.join(", ")}</b>.</div>`
        : "";

      document.getElementById("resultado").innerHTML = tabela + alerta;
      statusMsg(`Lista de materiais gerada com sucesso (${linhasBOM.length} itens).`,"ok");

      // Habilita PDF e guarda contexto
      document.getElementById("btnPDF").disabled = (linhasBOM.length===0);
      ultimoContextoPDF = { numero, cliente, data, vendidos, linhasBOM };

    }catch(e){
      console.error(e);
      statusMsg("Erro ao ler a planilha. Verifique o compartilhamento e os nomes das abas.", "err");
      document.getElementById("btnPDF").disabled = true;
      document.getElementById("resultado").innerHTML = "";
    }
  }

  async function gerarPDF(){
    if (!ultimoContextoPDF) return;
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    const { numero, cliente, data, vendidos, linhasBOM } = ultimoContextoPDF;

    // Cabe√ßalho
    doc.setFontSize(14);
    doc.text("Libera√ß√£o de Materiais (BOM)", 14, 16);
    doc.setFontSize(11);
    let y = 26;
    doc.text(`Or√ßamento: ${numero}`, 14, y); y += 6;
    if (cliente) { doc.text(`Cliente: ${cliente}`, 14, y); y += 6; }
    if (data)    { doc.text(`Data: ${data}`, 14, y); y += 6; }
    doc.setFontSize(10);
    doc.text(`Produtos vendidos: ${vendidos.map(v=>`${v.nome} (x${v.qtd})`).join(" | ")}`, 14, y); y += 8;

    // Tabela
    const colW = [110, 30, 40]; // Insumo, Unidade, Qtd
    const startX = 14;
    const startY = y;

    // Cabe√ßalho da tabela
    doc.setFontSize(10);
    doc.setDrawColor(200);
    doc.setFillColor(241,244,249);
    doc.rect(startX, startY, colW[0], 8, "F");
    doc.rect(startX+colW[0], startY, colW[1], 8, "F");
    doc.rect(startX+colW[0]+colW[1], startY, colW[2], 8, "F");
    doc.setTextColor(0);
    doc.text("Insumo", startX+2, startY+5.5);
    doc.text("Unidade", startX+colW[0]+2, startY+5.5);
    doc.text("Quantidade", startX+colW[0]+colW[1]+2, startY+5.5);

    let cy = startY + 8;
    doc.setFontSize(10);
    linhasBOM.forEach(row=>{
      if (cy > 280){ // quebra de p√°gina
        doc.addPage();
        cy = 16;
      }
      doc.rect(startX, cy, colW[0], 8);
      doc.rect(startX+colW[0], cy, colW[1], 8);
      doc.rect(startX+colW[0]+colW[1], cy, colW[2], 8);
      doc.text(String(row.insumo), startX+2, cy+5.5, {maxWidth: colW[0]-4});
      doc.text(String(row.unidade||""), startX+colW[0]+2, cy+5.5, {maxWidth: colW[1]-4});
      doc.text(String(row.quantidade).replace(".",","), startX+colW[0]+colW[1]+2, cy+5.5, {maxWidth: colW[2]-4});
      cy += 8;
    });

    doc.save(`Liberacao_${numero}.pdf`);
  }
  </script>
</body>
</html>

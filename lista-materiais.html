<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Consulta de Lista de Materiais</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 40px;
      background: url('inicial.jpg') no-repeat center center fixed;
      background-size: cover;
    }
    .container {
      background: rgba(255, 255, 255, 0.95);
      padding: 20px;
      border-radius: 10px;
      max-width: 1000px;
      margin: auto;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 15px;
    }
    th, td {
      border: 1px solid #999;
      padding: 8px;
      text-align: center;
    }
    th {
      background-color: #333;
      color: white;
    }
    .botao {
      margin-top: 15px;
      padding: 10px 15px;
      background-color: #4CAF50;
      color: white;
      border: none;
      cursor: pointer;
      border-radius: 4px;
    }
    .botao:hover {
      background-color: #388e3c;
    }
    .mensagem {
      margin-top: 10px;
      font-weight: bold;
    }
    input {
      padding: 10px;
      font-size: 16px;
      margin-bottom: 10px;
      width: 250px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>🔍 Consulta de Lista de Materiais</h2>
    <input type="text" id="numeroOrcamento" placeholder="Digite o número do orçamento" />
    <button class="botao" onclick="gerarLista()">Gerar Lista de Materiais</button>

    <div id="tituloLista"></div>

    <table id="tabelaMateriais" style="display:none;">
      <thead>
        <tr>
          <th>Produto</th>
          <th>Peça</th>
          <th>Tipo</th>
          <th>Comprimento (cm)</th>
          <th>Qtd Total</th>
          <th>Plano de Corte</th>
          <th>Barras</th>
          <th>Aproveitamento</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <button class="botao" onclick="salvarNaPlanilha()">💾 Salvar na Planilha</button>
    <button class="botao" onclick="gerarPDF()">🧾 Gerar PDF</button>

    <div id="mensagem" class="mensagem"></div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbziZ9TTcYKOx1QOsmGXUSZ5rZu9lM6XFmyNOftnt1hmUE6PBloYLDWW-5A2v705khGf/exec';
    let listaDeMateriais = [];

    let html = `<table>
        <thead>
          <tr>
            <th>Código</th>
            <th>Descrição</th>
            <th>Qtd. Peças</th>
            <th>Comp. (cm)</th>
            <th>Tam. Barra (cm)</th>
            <th>Peças/Barra</th>
            <th>Barras Necessárias</th>
            <th>Sobra (cm)</th>
            <th>Alerta</th>
          </tr>
        </thead>
        <tbody>`;

      const planoAgrupado = {};

      dados.forEach(item => {
        const codigo = item.codigo;
        const comp = parseFloat(item.comprimento); // já em cm
        const barra = parseFloat(item.tamanhoBarra); // já em cm
        const qtd = parseFloat(item.quantidade);
        const porBarra = parseInt(item.pecasPorBarra);
        const barras = parseInt(item.barrasNecessarias);
        const sobra = parseFloat(item.sobraPorBarra); // já em cm

        html += `
          <tr>
            <td>${codigo}</td>
            <td>${item.descricao}</td>
            <td>${qtd}</td>
            <td>${formatar(comp)}</td>
            <td>${formatar(barra)}</td>
            <td>${porBarra}</td>
            <td>${barras}</td>
            <td>${formatar(sobra)}</td>
            <td class="${item.alerta ? 'alerta' : ''}">${item.alerta || ''}</td>
          </tr>`;

        // Agrupamento para plano de corte
        if (!planoAgrupado[codigo]) {
          planoAgrupado[codigo] = {
            codigo: codigo,
            barra: barra,
            comp: comp,
            porBarra: porBarra,
            barras: barras,
            sobra: sobra
          };
        } else {
          planoAgrupado[codigo].barras += barras;
        }
      });

      html += `</tbody></table>`;
      document.getElementById("resultado").innerHTML = html;

      // Gerar plano de corte agrupado
      let planoHtml = `<h3>Plano de Corte Agrupado</h3>
      <table>
        <thead>
          <tr>
            <th>Código</th>
            <th>Tam. Barra (cm)</th>
            <th>Comprimento da Peça (cm)</th>
            <th>Peças/Barra</th>
            <th>Barras</th>
            <th>Sobra (cm)</th>
          </tr>
        </thead>
        <tbody>`;

      for (let cod in planoAgrupado) {
        const p = planoAgrupado[cod];
        planoHtml += `
          <tr>
            <td>${p.codigo}</td>
            <td>${formatar(p.barra)}</td>
            <td>${formatar(p.comp)}</td>
            <td>${p.porBarra}</td>
            <td>${p.barras}</td>
            <td>${formatar(p.sobra)}</td>
          </tr>`;
      }
      planoHtml += `</tbody></table>`;
      document.getElementById("planoDeCorte").innerHTML = planoHtml;
    }

    function gerarPDF() {
      const janela = window.open('', '', 'width=800,height=600');
      const conteudo = document.getElementById("resultado").innerHTML + document.getElementById("planoDeCorte").innerHTML;
      janela.document.write('<html><head><title>Lista de Materiais</title></head><body>');
      janela.document.write('<h2 style="text-align:center;">Lista de Materiais</h2>');
      janela.document.write(conteudo);
      janela.document.write('</body></html>');
      janela.document.close();
      janela.print();
    }
  </script>
</body>
</html>

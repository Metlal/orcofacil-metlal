<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Liberação de Materiais</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    h2 {
      text-align: center;
    }
    input, button {
      padding: 8px;
      margin: 5px 0;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: center;
    }
    th {
      background-color: #f4f4f4;
    }
    .alerta {
      color: red;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h2>Liberação de Materiais</h2>

  <label for="ordemInput">Número da Ordem de Produção:</label><br>
  <input type="text" id="ordemInput" placeholder="Digite o número da ordem" />
  <button onclick="buscarMateriais()">Consultar</button>
  <button onclick="gerarPDF()">Gerar PDF</button>

  <div id="resultado"></div>
  <div id="planoDeCorte"></div>

  <script>
    function formatar(valor) {
      return parseFloat(valor).toFixed(2);
    }

    async function buscarMateriais() {
      const ordem = document.getElementById("ordemInput").value.trim();
      if (!ordem) return alert("Digite o número da ordem de produção.");

      const url = 'https://script.google.com/macros/s/AKfycbzuG20OPt5pOpU7I0GNuSvElPE6RLzdwBA9St6dqmofaL5VGnIkIGlXhX5qKaB7aOcS/exec' + ordem;
      const response = await fetch(url);
      const dados = await response.json();

      if (!dados || dados.length === 0) {
        document.getElementById("resultado").innerHTML = "<p>Nenhum material encontrado.</p>";
        return;
      }

      let html = `<table>
        <thead>
          <tr>
            <th>Código</th>
            <th>Descrição</th>
            <th>Qtd. Peças</th>
            <th>Comp. (cm)</th>
            <th>Tam. Barra (cm)</th>
            <th>Peças/Barra</th>
            <th>Barras Necessárias</th>
            <th>Sobra (cm)</th>
            <th>Alerta</th>
          </tr>
        </thead>
        <tbody>`;

      const planoAgrupado = {};

      dados.forEach(item => {
        const codigo = item.codigo;
        const comp = parseFloat(item.comprimento) * 100; // mm to cm
        const barra = parseFloat(item.tamanhoBarra) * 100; // mm to cm
        const qtd = parseFloat(item.quantidade);
        const porBarra = parseInt(item.pecasPorBarra);
        const barras = parseInt(item.barrasNecessarias);
        const sobra = parseFloat(item.sobraPorBarra) * 100;

        html += `
          <tr>
            <td>${codigo}</td>
            <td>${item.descricao}</td>
            <td>${qtd}</td>
            <td>${formatar(comp)}</td>
            <td>${formatar(barra)}</td>
            <td>${porBarra}</td>
            <td>${barras}</td>
            <td>${formatar(sobra)}</td>
            <td class="${item.alerta ? 'alerta' : ''}">${item.alerta || ''}</td>
          </tr>`;

        // Agrupamento para plano de corte
        if (!planoAgrupado[codigo]) {
          planoAgrupado[codigo] = {
            codigo: codigo,
            barra: barra,
            comp: comp,
            porBarra: porBarra,
            barras: barras,
            sobra: sobra
          };
        } else {
          planoAgrupado[codigo].barras += barras;
        }
      });

      html += `</tbody></table>`;
      document.getElementById("resultado").innerHTML = html;

      // Gerar plano de corte agrupado
      let planoHtml = `<h3>Plano de Corte Agrupado</h3>
      <table>
        <thead>
          <tr>
            <th>Código</th>
            <th>Tam. Barra (cm)</th>
            <th>Comprimento da Peça (cm)</th>
            <th>Peças/Barra</th>
            <th>Barras</th>
            <th>Sobra (cm)</th>
          </tr>
        </thead>
        <tbody>`;

      for (let cod in planoAgrupado) {
        const p = planoAgrupado[cod];
        planoHtml += `
          <tr>
            <td>${p.codigo}</td>
            <td>${formatar(p.barra)}</td>
            <td>${formatar(p.comp)}</td>
            <td>${p.porBarra}</td>
            <td>${p.barras}</td>
            <td>${formatar(p.sobra)}</td>
          </tr>`;
      }
      planoHtml += `</tbody></table>`;
      document.getElementById("planoDeCorte").innerHTML = planoHtml;
    }

    function gerarPDF() {
      const janela = window.open('', '', 'width=800,height=600');
      const conteudo = document.getElementById("resultado").innerHTML + document.getElementById("planoDeCorte").innerHTML;
      janela.document.write('<html><head><title>Lista de Materiais</title></head><body>');
      janela.document.write('<h2 style="text-align:center;">Lista de Materiais</h2>');
      janela.document.write(conteudo);
      janela.document.write('</body></html>');
      janela.document.close();
      janela.print();
    }
  </script>
</body>
</html>

<script>
  let tabelaPreco = {};
  let listaItens = [];
  const sheetID = "1HhXN32p7V9NtzuuG-Xr03uBts_W2yNLBqosnZuWwGn8";
  const produtosSheet = "Página1";
  const orcamentosSheet = "Orcamentos";

  const urlProdutos = `https://docs.google.com/spreadsheets/d/${sheetID}/gviz/tq?sheet=${produtosSheet}`;

  function carregarPrecos() {
    fetch(urlProdutos)
      .then(res => res.text())
      .then(data => {
        const jsonData = JSON.parse(data.substr(47).slice(0, -2));
        const rows = jsonData.table.rows;
        const select = document.getElementById("produto");
        select.innerHTML = "";

        rows.forEach(row => {
          const nome = row.c[0]?.v;
          const preco = parseFloat(row.c[1]?.v);
          const tipo = row.c[2]?.v?.toLowerCase();
          if (nome && preco && tipo) {
            const produtoKey = nome.toLowerCase();
            tabelaPreco[produtoKey] = { preco, tipo };
            const option = document.createElement("option");
            option.value = produtoKey;
            option.textContent = nome;
            select.appendChild(option);
          }
        });
      })
      .catch(err => {
        alert("Erro ao carregar produtos.");
        console.error(err);
      });
  }

  function adicionarItem() {
    const produto = document.getElementById("produto").value;
    const largura = parseFloat(document.getElementById("largura").value);
    const altura = parseFloat(document.getElementById("altura").value);
    const comprimento = parseFloat(document.getElementById("comprimento").value);
    const quantidade = parseInt(document.getElementById("quantidade").value);

    if (!produto || isNaN(quantidade)) {
      alert("Preencha os campos corretamente.");
      return;
    }

    const dadosProduto = tabelaPreco[produto];
    if (!dadosProduto) {
      alert("Produto não encontrado.");
      return;
    }

    const { preco, tipo } = dadosProduto;
    let subtotal = 0;
    let descricao = "";

    if (tipo === "m2") {
      if (isNaN(largura) || isNaN(altura)) {
        alert("Informe largura e altura para m².");
        return;
      }
      const area = largura * altura;
      subtotal = preco * area * quantidade;
      descricao = `Área: ${area.toFixed(2)} m² | Preço m²: R$ ${preco.toFixed(2)}`;
    } else if (tipo === "m") {
      if (isNaN(comprimento)) {
        alert("Informe o comprimento.");
        return;
      }
      subtotal = preco * comprimento * quantidade;
      descricao = `Comprimento: ${comprimento.toFixed(2)} m | Preço/m: R$ ${preco.toFixed(2)}`;
    } else if (tipo === "unidade") {
      subtotal = preco * quantidade;
      descricao = `Preço unitário: R$ ${preco.toFixed(2)}`;
    }

    listaItens.push({ produto, quantidade, descricao, subtotal });
    atualizarLista();
  }

  function removerItem(i) {
    listaItens.splice(i, 1);
    atualizarLista();
  }

  function atualizarLista() {
    const container = document.getElementById("itensOrcamento");
    let html = "<h3>Itens do Orçamento</h3><ul>";
    let total = 0;

    listaItens.forEach((item, i) => {
      html += `<li><strong>${item.produto}</strong> (${item.quantidade}): ${item.descricao} – <strong>Subtotal:</strong> R$ ${item.subtotal.toFixed(2)} 
        <button onclick="removerItem(${i})">❌ Remover</button></li>`;
      total += item.subtotal;
    });

    html += `</ul><p><strong>Total Geral:</strong> R$ ${total.toFixed(2)}</p>`;
    container.innerHTML = html;
  }

  async function salvarOrcamentoNaPlanilha(dados) {
    const scriptURL = "https://script.google.com/macros/s/AKfycbxVCusrBVzH8SYZoKLEubYBftggZKOeU9B-xkxWabLGash3eskYNOwxAsiPuMGiTNys/exec";  
    try {
      await fetch(scriptURL, {
        method: "POST",
        body: JSON.stringify(dados),
        headers: { "Content-Type": "application/json" }
      });
    } catch (error) {
      console.error("Erro ao salvar no Google Sheets:", error);
    }
  }

  function gerarPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const cliente = document.getElementById("cliente").value;
    const numero = document.getElementById("numero").value;
    const data = document.getElementById("data").value;

    if (!cliente || !numero || !data || listaItens.length === 0) {
      alert("Preencha os dados e adicione itens.");
      return;
    }

    doc.setFontSize(12);
    doc.text("METLAL METALÚRGICA LADEIRA LTDA", 10, 10);
    doc.text("CNPJ: 00.000.000/0001-00", 10, 16);
    doc.text("Rua Jurucê, 78 – Colégio – RJ", 10, 22);
    doc.text("CEP: 21545-170", 10, 28);

    doc.text(`Cliente: ${cliente}`, 10, 38);
    doc.text(`Orçamento Nº: ${numero}`, 10, 44);
    doc.text(`Data: ${data}`, 10, 50);

    doc.setFontSize(14);
    doc.text("Itens:", 10, 60);
    let y = 70;
    let total = 0;
    let produtosResumo = [];

    listaItens.forEach(item => {
      doc.setFontSize(12);
      doc.text(`Produto: ${item.produto}`, 10, y); y += 6;
      doc.text(`Qtd: ${item.quantidade} | ${item.descricao}`, 10, y); y += 6;
      doc.text(`Subtotal: R$ ${item.subtotal.toFixed(2)}`, 10, y); y += 10;
      total += item.subtotal;
      produtosResumo.push(`${item.produto} (${item.quantidade})`);
    });

    doc.setFontSize(13);
    doc.text(`Total Geral: R$ ${total.toFixed(2)}`, 10, y); y += 20;

    doc.line(20, y, 100, y);
    doc.text("Assinatura do Cliente", 20, y + 6);
    doc.line(120, y, 200, y);
    doc.text("Assinatura do Vendedor", 120, y + 6);

doc.save("orcamento_METLAL.pdf");

  // Enviar dados para a planilha após gerar o PDF
  enviarParaPlanilha(cliente, numero, data, itensTexto, total);
}

function enviarParaPlanilha(cliente, numero, data, itensTexto, total) {
  fetch("https://script.google.com/macros/s/AKfycbxRXoMtvwrKc0jlx68GDBsmjNBkiYPzjgYi7mv-SUE57Gk6kWzarPl8MskACntRsq9e/exec", {
    method: "POST",
    headers: {
      "Content-Type": "application/json"
    },
    body: JSON.stringify({
      cliente,
      numero,
      data,
      itens: itensTexto,
      total: total.toFixed(2)
    })
  
  .then(res => res.text())
  .then(msg => console.log("Resposta do Google Apps Script:", msg))
  .catch(err => console.error("Erro ao enviar para planilha:", err));

  document.addEventListener("DOMContentLoaded", carregarPrecos);
</script>

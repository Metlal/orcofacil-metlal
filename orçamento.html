<!DOCTYPE html><html lang="pt-BR">
<head>
<meta charset="UTF-8" /><meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Or√ßaf√°cil METLAL</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
  body, input, select, button { font-family: 'Inter', sans-serif; }
  .hidden { display: none; }
  .login, .container { max-width: 400px; margin: 60px auto; padding:20px; background:#fff; border-radius:8px; box-shadow:0 4px 12px rgba(0,0,0,0.08);}
  .container { max-width:850px; }
  label, h2, p { margin: 10px 0; }
  input, select, button { width:100%; padding:10px; margin:6px 0; border-radius:6px; border:1px solid #ccc; }
  button { background:#0056b3; color:#fff; border:none; cursor:pointer; }
  button:hover { background:#003f88; }
  #itensOrcamento ul { padding-left: 20px; }
  #itensOrcamento li { margin-bottom: 10px; }
  .total { font-size:18px; color:green; font-weight:bold; }
</style>
</head>
<body><!-- Login Screen --><div id="loginScreen" class="login">
  <h2>Login METLAL</h2>
  <label>Usu√°rio:</label>
  <input id="usuario" type="text" placeholder="admin"/>
  <label>Senha:</label>
  <input id="senha" type="password" placeholder="1234"/>
  <button onclick="fazerLogin()">Entrar</button>
</div><!-- Main App --><div id="mainContent" class="container hidden">
  <h2>Or√ßaf√°cil METLAL</h2>
  <div>
    <label>Nome do Cliente:</label>
    <input id="cliente" type="text" placeholder="Nome do cliente"/>
    <label>N√∫mero do Or√ßamento:</label>
    <input id="numero" type="text" readonly/>
    <label>Data:</label>
    <input id="data" type="date"/>
    <button onclick="novoOrcamento()">üÜï Novo Or√ßamento</button>
  </div>  <hr/>  <div>
    <label>Produto:</label>
    <select id="produto"><option>Carregando...</option></select>
    <label>Largura (m):</label><input id="largura" type="number" step="0.01"/>
    <label>Altura (m):</label><input id="altura" type="number" step="0.01"/>
    <label>Comprimento (m):</label><input id="comprimento" type="number" step="0.01"/>
    <label>Quantidade:</label><input id="quantidade" type="number" min="1" value="1"/>
    <button onclick="adicionarItem()">‚ûï Adicionar ao Or√ßamento</button>
  </div>  <div id="itensOrcamento"></div>  <div style="margin-top:20px;">
    <button onclick="gerarPDF()">üìÖ Gerar PDF e Salvar</button>
  </div>
</div><script>
  const usuario = document.getElementById("usuario");
  const senha = document.getElementById("senha");
  const loginScreen = document.getElementById("loginScreen");
  const mainContent = document.getElementById("mainContent");
  const produto = document.getElementById("produto");
  const numero = document.getElementById("numero");
  const data = document.getElementById("data");
  const cliente = document.getElementById("cliente");
  const largura = document.getElementById("largura");
  const altura = document.getElementById("altura");
  const comprimento = document.getElementById("comprimento");
  const quantidade = document.getElementById("quantidade");
  const itensOrcamento = document.getElementById("itensOrcamento");

  const loginUser = "admin", loginPass = "1234";
  const sheetID = "1HhXN32p7V9NtzuuG-Xr03uBts_W2yNLBqosnZuWwGn8";
  const sheetName = "Precos";
  const sheetURL = https://docs.google.com/spreadsheets/d/${sheetID}/gviz/tq?sheet=${sheetName};
  const webAppURL = "https://script.google.com/macros/s/AKfycbwyhOVraf3G4UMCQEfsAEBWasHZa_emnyjH9jE8nS0SmYuCnZPYTrG6_tW5MleJEbog/exec?tipo=produtos ";

  let tabelaPreco = {}, listaItens = [], contador = 0;

  function fazerLogin() {
    if (usuario.value === loginUser && senha.value === loginPass) {
      loginScreen.classList.add("hidden");
      mainContent.classList.remove("hidden");
      novoOrcamento();
      carregarProdutos();
    } else {
      alert("Credenciais inv√°lidas");
    }
  }

  function carregarProdutos() {
    fetch(sheetURL)
      .then(r => r.text())
      .then(t => {
        const js = JSON.parse(t.substring(47).slice(0,-2));
        produto.innerHTML = "<option value=''>-- selecione --</option>";
        js.table.rows.forEach(r => {
          const nome = r.c[0]?.v, preco = r.c[1]?.v, tipo = r.c[2]?.v;
          if(nome && preco && tipo) {
            tabelaPreco[nome] = {preco: parseFloat(preco), tipo: tipo.toLowerCase()};
            produto.innerHTML += <option value="${nome}">${nome}</option>;
          }
        });
      })
      .catch(err => {
        alert("Erro ao carregar produtos");
        produto.innerHTML = "<option value=''>erro</option>";
        console.error(err);
      });
  }

  function novoOrcamento() {
    contador++;
    numero.value = MT${String(contador).padStart(4, "0")};
    data.value = new Date().toISOString().split("T")[0];
    cliente.value = "";
    listaItens = [];
    atualizarLista();
  }

  function adicionarItem() {
    const nome = produto.value;
    const qtd = parseInt(quantidade.value);
    const dados = tabelaPreco[nome];
    if (!nome || !dados || qtd <= 0) return alert("Selecione produto e quantidade v√°lidos.");

    let sub = 0, desc = "";

    if (dados.tipo === "m2") {
      const l = parseFloat(largura.value);
      const a = parseFloat(altura.value);
      if (isNaN(l) || isNaN(a)) return alert("Informe largura e altura corretamente.");
      const area = l * a;
      sub = dados.preco * area * qtd;
      desc = √Årea ${area.toFixed(2)} m¬≤;
    } else if (dados.tipo === "m") {
      const c = parseFloat(comprimento.value);
      if (isNaN(c)) return alert("Informe comprimento corretamente.");
      sub = dados.preco * c * qtd;
      desc = Comp ${c.toFixed(2)} m;
    } else {
      sub = dados.preco * qtd;
      desc = "Unidade";
    }

    listaItens.push({nome, qtd, desc, sub});
    atualizarLista();

    produto.value = "";
    largura.value = "";
    altura.value = "";
    comprimento.value = "";
    quantidade.value = 1;
  }

  function atualizarLista() {
    let html = "<h3>Itens:</h3><ul>", tot = 0;
    listaItens.forEach((it, i) => {
      html += <li>${it.nome} x${it.qtd} (${it.desc}) ‚Äì R$ ${it.sub.toFixed(2)} <button onclick="remover(${i})">‚ùå</button></li>;
      tot += it.sub;
    });
    html += </ul><p class="total">Total: R$ ${tot.toFixed(2)}</p>;
    itensOrcamento.innerHTML = html;
  }

  function remover(i) {
    listaItens.splice(i, 1);
    atualizarLista();
  }

  function gerarPDF() {
    if (!cliente.value || listaItens.length === 0) return alert("Preencha todas as informa√ß√µes e adicione pelo menos um item.");

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    doc.text(Cliente: ${cliente.value}, 10, 20);
    doc.text(Or√ßamento: ${numero.value} | Data: ${data.value}, 10, 26);

    let y = 36, tot = 0;
    listaItens.forEach(it => {
      doc.text(‚Ä¢ ${it.nome} x${it.qtd} (${it.desc}) - R$${it.sub.toFixed(2)}, 10, y);
      tot += it.sub;
      y += 6;
    });

    doc.text(Total: R$${tot.toFixed(2)}, 10, y + 10);
    doc.save(${numero.value}.pdf);

    const produtosTexto = listaItens.map(item => ${item.nome} (${item.qtd}) - ${item.desc}).join(" | ");

    fetch(webAppURL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        tipo: "salvar",
        numero: numero.value,
        cliente: cliente.value,
        data: data.value,
        total: tot.toFixed(2),
        produtos: produtosTexto,
        usuario: usuario.value,
        status: "Pendente"
      })
    })
    .then(() => alert("Or√ßamento salvo com sucesso!"))
    .catch(() => alert("Erro ao salvar or√ßamento."));
  }
</script></body>
</html>
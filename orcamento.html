<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" /><meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Or√ßaf√°cil METLAL</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    /* Manter seu estilo atual... */
  </style>
</head>
<body>
<div class="container">
  <div class="empresa-info">
    <img src="logo-metlal.png" alt="Logo METLAL"><h2>METLAL METAL√öRGICA LADEIRA LTDA</h2>
    <p>CNPJ: 00.000.000/0001-00</p><p>Rua Juruc√™, 78 ‚Äì Col√©gio ‚Äì RJ</p><p>CEP: 21545‚Äë170</p>
  </div>

  <form onsubmit="return false;">
    <label>Nome do Cliente:</label><input id="cliente" type="text" required>
    <label>N√∫mero do Or√ßamento:</label><input id="numero" readonly>
    <label>Data:</label><input id="data" type="date" required>
    <label>Produto:</label><select id="produto"><option>Carregando...</option></select>
    <label>Largura (m):</label><input id="largura" type="number" step="0.01">
    <label>Altura (m):</label><input id="altura" type="number" step="0.01">
    <label>Comprimento (m):</label><input id="comprimento" type="number" step="0.01">
    <label>Quantidade:</label><input id="quantidade" type="number" min="1" value="1" required>
    <button onclick="adicionarItem()">‚ûï Adicionar ao Or√ßamento</button>
  </form>

  <div id="itensOrcamento"></div>

  <div style="text-align:center;margin-top:20px;">
    <button onclick="gerarPDF()">üì• Baixar PDF</button>
    <button onclick="novoOrcamento()">üÜï Novo Or√ßamento</button>
  </div>
</div>

<script>
  let tabelaPreco = {}, listaItens = [];
  const sheetID = "1HhXN32p7V9NtzuuG-Xr03uBts_W2yNLBqosnZuWwGn8";
  const sheetName = "P√°gina1";
  const sheetURL = "https://docs.google.com/spreadsheets/d/${sheetID}/gviz/tq?sheet=${sheetName}";
  const saveURL = "https://script.google.com/macros/s/AKfycbxRXoMtvwrKc0..."

  function carregarPrecos() {
    fetch(sheetURL)
      .then(r => r.text())
      .then(txt => {
        const js = JSON.parse(txt.substr(47).slice(0,-2));
        const select = document.getElementById("produto");
        select.innerHTML = "<option value=''>Selecione...</option>";
        js.table.rows.forEach(r => {
          const nome=r.c[0]?.v, preco=parseFloat(r.c[1]?.v), tipo=r.c[2]?.v?.toLowerCase();
          if(nome && preco && tipo) {
            tabelaPreco[nome]= { preco, tipo };
            const opt = document.createElement("option");
            opt.value = nome;
            opt.textContent = nome;
            select.appendChild(opt);
          }
        });
      })
      .catch(e=>alert("Falha ao carregar produtos."+e));
  }

  function gerarNumeroSequencial() {
    let seq = parseInt(localStorage.getItem("contadorOrcamentos")||"0")+1;
    localStorage.setItem("contadorOrcamentos", seq);
    return "MT"+seq.toString().padStart(4,"0");
  }

  function novoOrcamento() {
    listaItens=[];
    document.getElementById("cliente").value="";
    document.getElementById("largura").value="";
    document.getElementById("altura").value="";
    document.getElementById("comprimento").value="";
    document.getElementById("quantidade").value=1;
    document.getElementById("numero").value = gerarNumeroSequencial();
    document.getElementById("data").value = new Date().toISOString().split("T")[0];
    document.getElementById("itensOrcamento").innerHTML="";
  }

  function adicionarItem() {
    const prod=document.getElementById("produto").value;
    const qtd=parseInt(document.getElementById("quantidade").value);
    if(!prod||isNaN(qtd)){alert("Preencha corretamente");return;}
    const { preco, tipo } = tabelaPreco[prod];
    let subtotal=0, descricao="";
    if(tipo==="m2") {
      const l=parseFloat(document.getElementById("largura").value),
            a=parseFloat(document.getElementById("altura").value);
      if(isNaN(l)||isNaN(a)){return alert("Informe L e A");}
      const area=l*a;
      subtotal=preco*area*qtd;
      descricao=`√Årea:${area.toFixed(2)}m¬≤|R$ ${preco}`;
    }
    else if(tipo==="m") {
      const c=parseFloat(document.getElementById("comprimento").value);
      if(isNaN(c)){return alert("Informe comprimento");}
      subtotal=preco*c*qtd;
      descricao=`Comprimento:${c}m|R$ ${preco}`;
    }
    else {
      subtotal=preco*qtd;
      descricao=`Unit√°rio|R$ ${preco}`;
    }
    listaItens.push({ prod, qtd, descricao, subtotal });
    atualizarLista();
  }

  function atualizarLista() {
    let html="<h3>Itens:</h3><ul>"; let tot=0;
    listaItens.forEach((it,i)=>{
      html+=`<li>${it.prod} (${it.qtd}): ${it.descricao} ‚Äì R$${it.subtotal.toFixed(2)} <button onclick="listaItens.splice(${i},1);atualizarLista()">‚ùå</button></li>`;
      tot+=it.subtotal;
    });
    html+=`</ul><p class="total">Total R$${tot.toFixed(2)}</p>`;
    document.getElementById("itensOrcamento").innerHTML=html;
  }

  function gerarPDF(){
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const cli=document.getElementById("cliente").value,
          num=document.getElementById("numero").value,
          data=document.getElementById("data").value;
    if(!cli||!num||listaItens.length==0){return alert("Preencha!");}
    doc.text(`Cliente: ${cli}`,10,40);
    listaItens.forEach((it,i)=>{
      doc.text(`${it.prod} x${it.qtd} - ${it.descricao}`,10,50+6*i);
    });
    const tot=listaItens.reduce((a,b)=>a+b.subtotal,0);
    doc.text(`Total R$${tot.toFixed(2)}`,10,50+6*listaItens.length+10);
    doc.save(`orcamento_${num}.pdf`);
    salvarOrcamento(cli,num, data, listaItens, tot);
  }

  function salvarOrcamento(cli,num,data,itens,tot){
    const prodStr = itens.map(i=>`${i.prod}(${i.qtd})`).join(",");
    fetch(saveURL,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({cliente:cli,numero:num,data,produtos:prodStr,total:tot.toFixed(2),status:"Em aberto",usuario:"projetos"})
    })
    .then(r=>r.text()).then(t=>console.log(t)).catch(e=>console.error(e));
  }

  document.addEventListener("DOMContentLoaded",()=>{
    carregarPrecos();
    novoOrcamento();
  });
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Ordem de Produ√ß√£o</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f4f4f4;
      margin: 0;
      padding: 30px;
    }
    .container {
      max-width: 900px;
      margin: auto;
      background: #fff;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    h2 {
      margin-bottom: 20px;
    }
    input {
      padding: 10px;
      margin: 5px 10px 10px 0;
      width: 200px;
    }
    button {
      padding: 10px 20px;
      margin: 5px;
      background-color: #2196F3;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    button:hover {
      background-color: #0b7dda;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    th, td {
      padding: 10px;
      border: 1px solid #ccc;
      text-align: center;
    }
    th {
      background-color: #333;
      color: white;
    }
    #mensagem {
      margin-top: 15px;
      font-weight: bold;
      color: green;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>‚úçÔ∏è Gerar Ordem de Produ√ß√£o</h2>

    <input type="text" id="numeroOrcamento" placeholder="N¬∫ Or√ßamento">
    <input type="text" id="responsavel" placeholder="Respons√°vel">
    <button onclick="gerarOrdem()">Gerar Ordem</button>

    <div id="tituloOrdem"></div>

    <table id="tabelaOrdem" style="display:none;">
      <thead>
        <tr>
          <th>Produto</th>
          <th>Pe√ßa</th>
          <th>Tipo</th>
          <th>Comprimento</th>
          <th>Quantidade</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <button onclick="salvarOrdem()">üíæ Salvar Ordem</button>
    <button onclick="gerarPDF()">üßæ Gerar PDF</button>

    <div id="mensagem"></div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwPb17NgbgDczYsH8J7sDa010LQjBBe81Ed1kr_eE1ey_g6znULxVRHQ6wXeF0py9eFV/exec';
    let listaOrdem = [];

    function gerarOrdem() {
      const numero = document.getElementById("numeroOrcamento").value.trim();
      const responsavel = document.getElementById("responsavel").value.trim();

      if (!numero || !responsavel) {
        alert("Preencha o n√∫mero do or√ßamento e o respons√°vel.");
        return;
      }

      fetch(`${SCRIPT_URL}?orcamento=${numero}`)
        .then(res => res.json())
        .then(data => {
          if (!data.length) {
            alert("Nenhum dado encontrado.");
            return;
          }

          const cliente = data[0].cliente || "Desconhecido";

          listaOrdem = data.map(item => ({
            ordem: numero,
            cliente: cliente,
            responsavel: responsavel,
            produto: item.produto,
            peca: item.peca,
            tipo: item.tipo,
            comprimento: item.comprimento,
            quantidade: item.qtdTotal || 0
          }));

          preencherTabelaOrdem(listaOrdem, numero, cliente, responsavel);
        });
    }

    function preencherTabelaOrdem(lista, numero, cliente, responsavel) {
      const tabela = document.getElementById("tabelaOrdem");
      const corpo = tabela.querySelector("tbody");
      corpo.innerHTML = "";

      document.getElementById("tituloOrdem").innerHTML = `<strong>Ordem:</strong> ${numero} | <strong>Cliente:</strong> ${cliente} | <strong>Respons√°vel:</strong> ${responsavel}`;

      lista.forEach(item => {
        const row = corpo.insertRow();
        row.innerHTML = `
          <td>${item.produto}</td>
          <td>${item.peca}</td>
          <td>${item.tipo}</td>
          <td>${item.comprimento}</td>
          <td>${item.quantidade}</td>
        `;
      });

      tabela.style.display = "table";
      document.getElementById("mensagem").innerText = "";
    }

    function salvarOrdem() {
      if (listaOrdem.length === 0) {
        alert("Gere uma ordem antes de salvar!");
        return;
      }

      fetch(SCRIPT_URL, {
        method: 'POST',
        body: JSON.stringify(listaOrdem),
        headers: {
          'Content-Type': 'application/json'
        }
      })
      .then(res => res.text())
      .then(msg => {
        document.getElementById("mensagem").innerText = msg;
      })
      .catch(() => {
        document.getElementById("mensagem").innerText = "Erro ao salvar a ordem.";
      });
    }

    function gerarPDF() {
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF();
      const titulo = document.getElementById("tituloOrdem").innerText;
      const rows = [...document.querySelectorAll("table tr")].map(tr =>
        [...tr.querySelectorAll("th, td")].map(td => td.innerText)
      );

      pdf.setFont("helvetica", "bold");
      pdf.setFontSize(14);
      pdf.text(titulo, 14, 20);

      const startY = 30;
      const rowHeight = 10;
      const colWidths = [35, 35, 35, 35, 35];

      let y = startY;
      rows.forEach((row, i) => {
        let x = 14;
        pdf.setFont("helvetica", i === 0 ? "bold" : "normal");
        row.forEach((cell, j) => {
          pdf.rect(x, y, colWidths[j], rowHeight);
          pdf.text(String(cell), x + 2, y + 7, { maxWidth: colWidths[j] - 4 });
          x += colWidths[j];
        });
        y += rowHeight;

        if (y > 270) {
          pdf.addPage();
          y = startY;
        }
      });

      pdf.save("Ordem_de_Producao.pdf");
    }
  </script>
</body>
</html>
